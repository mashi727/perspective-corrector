# プレゼン写真 台形補正ツール - 開発記録

## 概要

プレゼンテーション写真の台形歪みを補正するデスクトップアプリケーション。
PySide6 (Qt) + OpenCVで構築。

## 現在の仕様 (2025-12-15)

### 基本情報

| 項目 | 値 |
|------|-----|
| ファイル名 | `perspective_corrector.py` |
| フレームワーク | PySide6 (Qt6) |
| 画像処理 | OpenCV, NumPy |
| 対応画像形式 | JPEG, PNG, HEIC/HEIF |
| ウィンドウサイズ | 最小 1500x800 |
| スプリッター比率 | 350:1050 (ファイル一覧:画像表示) |

### 機能一覧

1. **ファイル一覧表示**
   - 左側パネルにディレクトリ内の画像ファイルを表示
   - 出力ファイル名の編集が可能
   - 2カラム構成（元ファイル名 | 出力名）

2. **4隅座標指定**
   - 手動クリック: 左上→右上→右下→左下の順で指定
   - 自動認識: Cannyエッジ検出による四角形検出
   - ドラッグによる座標調整（精密モード）

3. **拡大鏡表示**
   - マウス位置周辺を拡大表示
   - 象限に応じたオフセット表示（見やすさ向上）
   - 選択領域を半透明マゼンタでオーバーレイ

4. **自動認識設定**
   - リアルタイムプレビュー付き設定ダイアログ
   - パラメータ調整可能

5. **一括処理**
   - 設定済み画像を一括で台形補正
   - 出力サイズ: 1920x1080

### UI構成

```
+------------------+----------------------------------------+
|                  |  操作説明                              |
|  ファイル一覧    +----------------------------------------+
|  (350px)         |                                        |
|                  |           画像キャンバス               |
|  - 元ファイル    |           (拡大鏡表示あり)             |
|  - 出力名        |                                        |
|                  +----------------------------------------+
|  設定済み: n件   | 座標表示 | [座標クリア][自動認識]      |
|                  |          | [認識設定][一括処理][終了]   |
+------------------+----------------------------------------+
```

### ボタン配色

| ボタン | 色 | カラーコード | 用途 |
|--------|-----|-------------|------|
| 座標クリア | オレンジ | #E67E22 | リセット/警告 |
| 自動認識 | 青 | #3498DB | ツール/アクション |
| 認識設定 | 紫 | #9B59B6 | 設定/調整 |
| 一括処理 | 緑 | #27AE60 | 実行/確定 |
| 終了 | グレー | #7F8C8D | 終了 |

### 拡大鏡設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `magnifier_base_size` | 400px | 拡大鏡の基準サイズ（長辺） |
| `magnifier_zoom` | 1.75 | 拡大率 |
| `drag_precision` | 0.15 | ドラッグ時の減衰率（精密モード） |
| `drag_threshold` | 15px | ドラッグ判定の距離 |

### 自動認識パラメータ

| パラメータ | デフォルト値 | 範囲 | 説明 |
|-----------|-------------|------|------|
| `canny_low` | 50 | 0-255 | Cannyエッジ検出の低閾値 |
| `canny_high` | 150 | 0-255 | Cannyエッジ検出の高閾値 |
| `blur_size` | 5 | 1-21 | ガウシアンブラーのカーネルサイズ |
| `approx_epsilon` | 0.02 | 0.001-0.1 | 輪郭近似の精度係数 |
| `min_area_ratio` | 0.05 | 0.01-0.5 | 最小面積比率 |

### コーナー表示色

| コーナー | 色 |
|---------|-----|
| 左上 | 赤 (255, 0, 0) |
| 右上 | 緑 (0, 255, 0) |
| 右下 | 青 (0, 0, 255) |
| 左下 | 黄 (255, 255, 0) |

### 設定ファイル

- ファイル名: `perspective_config.json`
- 保存場所: 作業ディレクトリ
- 内容: 各画像の座標情報、出力ファイル名、自動認識設定

---

## 開発履歴

### Phase 1: 基本機能実装

- PySide6によるGUI構築
- OpenCVによる透視変換（台形補正）機能
- ファイル一覧表示と選択
- 4隅座標のクリック指定
- JSON設定ファイルによる座標保存

### Phase 2: 拡大鏡機能

- マウス位置周辺の拡大表示機能追加
- 半透明オーバーレイ（選択領域表示）
  - 赤 → 緑 → 黄 → シアン → **マゼンタ**（最終採用）
- 象限ベースのオフセット表示
  - マウスが画像の左半分にあれば拡大鏡を右にオフセット
  - マウスが画像の上半分にあれば拡大鏡を下にオフセット
  - オフセット量: 25%

### Phase 3: 精密ドラッグ

- コーナーのドラッグ移動機能
- 精密モード実装（0.15倍減衰）
- クリック時のコーナー位置同期

### Phase 4: 自動認識機能

- Cannyエッジ検出による四角形自動検出
- 「自動認識」ボタン追加

### Phase 5: 認識設定ダイアログ

- パラメータ調整ダイアログ実装
- リアルタイムプレビュー機能
  - ダイアログ内で即座に結果確認
  - OKで適用、キャンセルで破棄
- 設定のJSON保存対応

### Phase 6: UI調整

- ボタン配色の意味付け
- スプリッター比率調整 (350:1050)
- ウィンドウ最小サイズ調整 (1500px)
- 拡大鏡サイズ: 280 → 308 → 339 → **400px**
- クロスプラットフォームフォント対応
  - `QFont("Sans")` → `QFont()` (システムデフォルト)

### Phase 7: 通知の最適化

- 正常完了時のメッセージ表示を削除
  - 自動認識成功時: ステータスバーメッセージを削除
  - 一括処理成功時: 完了ダイアログを削除
- エラー発生時のみ警告ダイアログを表示

### Phase 8: パッケージ化・GitHub公開

- `pyproject.toml`追加によるpipインストール対応
- GitHubリポジトリ作成・公開
- README.md、LICENSE、.gitignore整備

### Phase 9: フォルダ操作機能

- **メニューバー追加**
  - ファイル(F) メニュー
  - フォルダを開く... (Cmd+O / Ctrl+O)
  - 最近使用したフォルダ（最大10件、履歴クリア機能）
  - 終了 (Cmd+Q / Ctrl+Q)
- **ウィンドウタイトル**: 現在のフォルダ名を表示
- **ドラッグ&ドロップ起動**: フォルダ/ファイルをexeにドロップで起動
- **ステータスバー改善**: 選択ファイルのフルパス or 作業フォルダを表示
- 最近使用したフォルダは `~/.perspective_corrector_recent.json` に保存

### Phase 10: ダイアログ中央配置

- **全ダイアログをメインウィンドウ中央に配置**
  - `center_dialog`ヘルパーメソッド追加
  - `show_message_box`メソッド追加（中央配置メッセージボックス）
- **対象ダイアログ**:
  - フォルダ選択ダイアログ (700x500)
  - 認識設定ダイアログ (800x600)
  - プログレスダイアログ (400x100)
  - 全メッセージボックス（警告、確認等）
- 非ネイティブダイアログ使用で位置制御を確実化
- ウィンドウ移動後も移動先の中心に表示
- **認識設定ダイアログの修正**
  - `showEvent`オーバーライドで表示時に中央配置
  - レイアウト確定後のサイズで正確に配置

### Phase 11: Windows HEIC対応強化

- **PyInstaller設定の改善**
  - `collect_all('pillow_heif')`で依存関係を自動収集
  - バイナリ、データ、hiddenimportsを自動バンドル
- WindowsでのHEIC/HEIF画像読み込みをサポート
- BUILD_WINDOWS.mdにHEIC対応の説明を追加

---

## ファイル構成

```
perspective-corrector/
├── perspective_corrector.py    # メインアプリケーション
├── pyproject.toml              # パッケージ設定
├── perspective_corrector.spec  # PyInstallerビルド設定
├── requirements.txt            # 依存パッケージ
├── README.md                   # プロジェクト説明
├── BUILD_WINDOWS.md            # Windowsビルド手順
├── DEVELOPMENT_LOG.md          # 本ファイル
├── LICENSE                     # MITライセンス
└── CLAUDE.md                   # Claude Code用設定（gitignore）
```

---

## インストール・実行

```bash
# GitHubからインストール
pip install git+https://github.com/mashi727/perspective-corrector.git

# 実行
perspective-corrector

# ディレクトリ指定
perspective-corrector /path/to/image/directory
```
